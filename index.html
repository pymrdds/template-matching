<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow"> <!-- æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é˜²æ­¢ -->
    <title>ç”»åƒãƒãƒƒãƒãƒ³ã‚°ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script> <!-- Pyodide æœ€æ–°ç‰ˆ -->
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f0f0f0;
            display: none; /* åˆæœŸçŠ¶æ…‹ã§éè¡¨ç¤º */
        }
        canvas, img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
        }
        #result, #initialResult {
            margin-top: 20px;
            font-size: 18px;
            white-space: pre-wrap;
            text-align: left;
            display: inline-block;
        }
        .result-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .result-row span {
            margin-right: 10px;
        }
        .button-container {
            margin: 10px 0;
        }
        button {
            padding: 5px 10px;
            margin: 5px;
        }
        input[type="number"] {
            width: 80px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>å¤§é­”ç‹ã´ã‚ˆã¾ã‚‹æ§˜ã®å´‡é«˜ãªã‚¢ãƒ—ãƒª (Webç‰ˆ)</h1>

    <div>
        <label for="imageUpload">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰:</label><br>
        <input type="file" id="imageUpload" accept="image/*" onchange="loadImage(event)">
    </div>

    <div>
        <label for="threshold">æ•´åˆç‡ (0-1):</label><br>
        <input type="number" id="threshold" step="0.001" min="0" max="1" value="0.9642">
    </div>

    <div class="button-container">
        <button onclick="checkImage()">ç”»åƒãƒã‚§ãƒƒã‚¯</button>
        <button onclick="initialPositionCheck()">åˆæœŸä½ç½®ãƒã‚§ãƒƒã‚¯</button>
    </div>

    <!-- çµæœè¡¨ç¤ºã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä¸Šã«é…ç½® -->
    <div id="result">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
    <div id="initialResult">ã“ã“ã«åˆæœŸä½ç½®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>

    <canvas id="canvas"></canvas>

    <!-- çµæœç”»åƒã‚’è¡¨ç¤ºï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ä½ç½®ï¼‰ -->
    <img id="resultImage" src="" alt="ãƒãƒƒãƒçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™" style="margin-top: 20px;">

    <script>
        // ç°¡æ˜“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·
        (function() {
            const correctPassword = "kanatanpyonsu";
            const password = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
            console.log("å…¥åŠ›ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ", password);
            if (password !== correctPassword || password === null) {
                console.log("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚");
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚");
                window.location.replace("about:blank");
                throw new Error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã‚’åœæ­¢ã—ã¾ã™ã€‚");
            } else {
                console.log("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚");
                document.body.style.display = "block";
            }
        })();

        let pyodide = null;
        let pyodideReady = false;
        let uploadedImage = null;
        let coordinates = {};
        let templateBytes = null;
        let csvData = {};

        const templateBase64 = "iVBORw0KGgoAAAANSUhEUgAAAA4AAAAwCAIAAACuWtxbAAAACXBIWXMAAAsTAAALEwEAmpwYAAADcElEQVRIiXWUzU4bSxCFz6mqbo89tnPFDcoVERs2WWSVB8hzRHnW7NhEyiuwiUDBJOJHIAIBd1dlMZ6xDdzWaBbT31RXnVNdvFqcpmacmsbu73l5yYsLnJ/Hz584PcVigcWCEXj3Du/f2z/tFMslrq/x6xeOj3FyEicnOD7G9+/x4wfPz2MyoRn29iy+fcNigbOz1fviAtfXcXPtNze4vZWHB87nMZtxZ8fi61ccHeHoCGcLXF7h7g61hrsTAAhAldNpzOdWvnzB1SWuruL2Fn/+oFZEAHCAQASEVFWaWT08DCIIBBBYr+ijkhRRVavooryw2KH9skoiAi/RHTrsWMxmeHzE42O4xzO0+6Jr9PdvlBLuvp1thw4/SPPpU/r4kW/fxmTiqhUoLz0VsNHnz8vDQ7+8LHd3tRSvdVCCgAAACqCAcW8vdnfrdFpyriqVQKxRB0SEk4lMpxa7u7GzU9u25FREfK3pSoGqyra1+dwiIshCVrIQ/kwEJcMMKVksl+FeI7r0n6NGhgjMDIHB9ArUbYfYlU86YORqK3oU27T2ellQwqzmXM0K+SQqAAM6ayxEPefaNCXnIvIcrX0B5hFQjZTcrJLlGVp67cyrg4Sqiw4oN9QdZDGSQTrp5AtliYQqzcTMVLWrvWwosFKKFBGmpDlrziYiATjgvSgbEYVmSIk5S0o2bAyx14qSkjNGI6QUqtZlP+i/iQapqmEWqqAYI7yHniQQvVUBgDAyYrvhn6B10JUM374YT/RfoyCCDLNqVillQ/0hakcbhJKzzWbSttVSgQxzZsi1ow1CmmnbyngcqqWbIIMCZBWppIMGd6hiNIqcXcQ3ZxcZOXM00pRUxOAOEaQEs64NhptIEeTMppGcRdRQVkX7RgUBBKGmHDfatjIahYihOvrtoV1WXaHCptHxmDkHxYLaWbDcsGDzz7WuAfH/cWszJRAWq7m0OnS4HgB0eyzY0PLDib52cnOG0oKMiFprqXXpvnQfLPBAjf7GEgbQI2opyw6NkO6ggMcq++EQakp5NsuTCVWHggKoZKhCFSQCgqCm1MxmuW1VlZtK9YMNJBAGQMysaZjzUuShbxQnTdXNoAqRCBgCFNGckfOjyP3QKKrZbIWSCJh7WNO0r1//e3Cw/+FD++ZNh0KkffXqv/393YODZj53978STunEdILQwwAAAABJRU5ErkJggg==";

        async function loadPyodideAndPackages() {
            try {
                pyodide = await loadPyodide();
                await pyodide.loadPackage(["opencv-python", "numpy"]);
                pyodideReady = true;
                console.log("Pyodide is ready");
                alert("Pyodide ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼");
                templateBytes = Uint8Array.from(atob(templateBase64), c => c.charCodeAt(0));
                console.log("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒï¼ˆBase64ï¼‰ãŒãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ");
                alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒï¼ˆBase64ï¼‰ãŒãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ");
            } catch (error) {
                console.error("Pyodide ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ", error);
                alert("Pyodide ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
        }

        async function fetchCSV() {
            const csvUrl = "https://raw.githubusercontent.com/Gorzmonst/monst25/main/initial-position_database_iphone16.csv";
            try {
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚§ãƒƒãƒã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.statusText}`);
                }
                const csvText = await response.text();
                parseCSV(csvText);
            } catch (error) {
                console.error("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚§ãƒƒãƒã«å¤±æ•—ã—ã¾ã—ãŸ: ", error);
                alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚§ãƒƒãƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
                // ãƒ•ã‚§ãƒƒãƒã«å¤±æ•—ã—ãŸå ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆCSVã®å†…å®¹ã«åˆã‚ã›ã¦æ›´æ–°ï¼‰
                csvData = {
                    '239,1670': { initial_position: '1', string_to_show: 'A-1' },
                    '239,1672': { initial_position: '2', string_to_show: 'A-2' },
                    '239,1674': { initial_position: '3', string_to_show: 'A-3' },
                    '239,1676': { initial_position: '4', string_to_show: 'A-4' },
                    '239,1678': { initial_position: '5', string_to_show: 'A-5' },
                    '239,1680': { initial_position: '6', string_to_show: 'A-6' },
                    '239,1682': { initial_position: '7', string_to_show: 'A-7' },
                    '239,1684': { initial_position: '8', string_to_show: 'A-8' },
                    '239,1686': { initial_position: '9', string_to_show: 'A-9' }
                };
            }
        }

        function parseCSV(csvText) {
            console.log("parseCSV ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ");
            csvData = {};
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(header => header.trim());

            // CSVã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæœŸå¾…é€šã‚Šã‹ç¢ºèª
            if (headers[0] !== 'x' || headers[1] !== 'y' || headers[2] !== 'initial-position' || headers[3] !== 'named-position' || headers[4] !== 'position') {
                alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚æœŸå¾…ã•ã‚Œã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼: x,y,initial-position,named-position,position");
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                csvData = {
                    '239,1670': { initial_position: '1', string_to_show: 'A-1' },
                    '239,1672': { initial_position: '2', string_to_show: 'A-2' },
                    '239,1674': { initial_position: '3', string_to_show: 'A-3' },
                    '239,1676': { initial_position: '4', string_to_show: 'A-4' },
                    '239,1678': { initial_position: '5', string_to_show: 'A-5' },
                    '239,1680': { initial_position: '6', string_to_show: 'A-6' },
                    '239,1682': { initial_position: '7', string_to_show: 'A-7' },
                    '239,1684': { initial_position: '8', string_to_show: 'A-8' },
                    '239,1686': { initial_position: '9', string_to_show: 'A-9' }
                };
                return;
            }

            // 2è¡Œç›®ä»¥é™ã‚’å‡¦ç†
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',').map(item => item.trim());
                if (row.length < 5) continue; // ä¸æ­£ãªè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
                const x = parseInt(row[0]);
                const y = parseInt(row[1]);
                const initial_position = row[2]; // initial-position
                const string_to_show = row[3];   // named-position
                const key = `${x},${y}`;
                csvData[key] = { initial_position, string_to_show };
            }
            console.log("CSVãƒ‡ãƒ¼ã‚¿ãŒãƒ‘ãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸ: ", csvData);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«Pyodideã¨CSVã‚’ãƒ­ãƒ¼ãƒ‰
        window.onload = async function() {
            console.log("ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ");
            alert("ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚");
            await loadPyodideAndPackages();
            await fetchCSV(); // CSVã‚’ãƒ•ã‚§ãƒƒãƒ
        };

        function loadImage(event) {
            console.log("loadImage ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ");
            const file = event.target.files[0];
            if (!file) {
                console.log("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
                alert("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    uploadedImage = img;
                    const canvas = document.getElementById('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    console.log("ç”»åƒãŒã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ã•ã‚Œã¾ã—ãŸ");
                };
                img.onerror = function() {
                    console.log("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
                };
            };
            reader.readAsDataURL(file);
        }

        async function checkImage() {
            console.log("checkImage ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ");
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = "å‡¦ç†ä¸­...";

            if (!pyodideReady) {
                console.log("Pyodide ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“: ", pyodideReady);
                resultDiv.textContent = "Pyodide ãŒã¾ã æº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚";
                alert("Pyodide ãŒã¾ã æº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!uploadedImage) {
                console.log("ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“: ", uploadedImage);
                resultDiv.textContent = "ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚";
                alert("ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!templateBytes) {
                console.log("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“: ", templateBytes);
                resultDiv.textContent = "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒï¼ˆBase64ï¼‰ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚";
                alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒï¼ˆBase64ï¼‰ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚");
                return;
            }

            try {
                const positions = await runMatching(false);
                console.log("æ¤œå‡ºã•ã‚ŒãŸä½ç½®: ", positions);
                displayResults(positions);
            } catch (error) {
                console.error("ç”»åƒãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ", error);
                resultDiv.textContent = "ã‚¨ãƒ©ãƒ¼: " + error.message;
                alert("ç”»åƒãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message + "\nã‚¹ã‚¿ãƒƒã‚¯: " + error.stack);
            }
        }

        async function initialPositionCheck() {
            console.log("initialPositionCheck ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ");
            const initialResultDiv = document.getElementById('initialResult');
            if (!pyodideReady) {
                console.log("pyodideReady: ", pyodideReady);
                alert("Pyodide ãŒã¾ã æº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!uploadedImage) {
                console.log("uploadedImage: ", uploadedImage);
                alert("ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!templateBytes) {
                console.log("templateBytes: ", templateBytes);
                alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒï¼ˆBase64ï¼‰ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (Object.keys(csvData).length === 0) {
                console.log("CSVãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
                alert("CSVãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚");
            }

            try {
                const positions = await runMatching(true);
                console.log("æ¤œå‡ºã•ã‚ŒãŸä½ç½®: ", positions);
                displayInitialResults(positions);
            } catch (error) {
                console.error("åˆæœŸä½ç½®ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ", error);
                initialResultDiv.textContent = "ã‚¨ãƒ©ãƒ¼: " + error.message;
                alert("åˆæœŸä½ç½®ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message + "\nã‚¹ã‚¿ãƒƒã‚¯: " + error.stack);
            }
        }

        async function runMatching(isInitial) {
            const threshold = parseFloat(document.getElementById("threshold").value);
            const imageInput = document.getElementById("imageUpload");
            const imgEl = document.getElementById("resultImage");
            const resultDiv = document.getElementById('result');

            if (imageInput.files.length === 0) {
                throw new Error("å¯¾è±¡ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
            }

            if (isNaN(threshold) || threshold < 0 || threshold > 1) {
                throw new Error("é–¾å€¤ã¯0ï½1ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            }

            const imageFile = imageInput.files[0];
            const imageExt = imageFile.name.split('.').pop().toLowerCase();
            const imageName = "uploaded." + imageExt;

            const imageBytes = new Uint8Array(await imageFile.arrayBuffer());
            pyodide.FS.writeFile('template.png', templateBytes);
            pyodide.FS.writeFile(imageName, imageBytes);

            const pythonCode = `
import cv2
import numpy as np
import base64
import json

log = []
try:
    log.append("ğŸ”¹ template èª­ã¿è¾¼ã¿ä¸­...")
    template = cv2.imread("template.png", 0)
    if template is None:
        raise Exception("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—")

    log.append("ğŸ”¹ å¯¾è±¡ç”»åƒ èª­ã¿è¾¼ã¿ä¸­...")
    img_color = cv2.imread("${imageName}")
    img_gray = cv2.cvtColor(img_color, cv2.COLOR_BGR2GRAY)

    log.append("ğŸ”¹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œä¸­...")
    res = cv2.matchTemplate(img_gray, template, cv2.TM_CCOEFF_NORMED)
    log.append("ğŸ”¹ é–¾å€¤ ${threshold} ä»¥ä¸Šã‚’æŠ½å‡ºä¸­...")
    loc = np.where(res >= ${threshold})
    result = list(zip(*loc[::-1]))

    min_distance = 10
    final_result = []
    for pt in result:
        add = True
        for other_pt in final_result:
            dist = np.linalg.norm(np.array(pt) - np.array(other_pt))
            if dist < min_distance:
                add = False
                break
        if add:
            final_result.append(pt)

    final_result_sorted = sorted(final_result, key=lambda x: x[0])

    h, w = template.shape
    log.append(f"ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã®ã‚µã‚¤ã‚º: å¹…={w}, é«˜ã•={h}")

    # ä¸­å¿ƒåº§æ¨™ã«å¤‰æ›ï¼ˆyåº§æ¨™ã«+1è£œæ­£ã‚’è¿½åŠ ï¼‰
    final_result_centered = [(round(pt[0] + w / 2.0), round(pt[1] + h / 2.0 + 1.0)) for pt in final_result_sorted]

    if final_result_sorted:
        log.append("âœ… ãƒãƒƒãƒç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆä¸­å¿ƒåº§æ¨™ï¼‰:")
        if len(final_result_sorted) > 5:
            log.append("âš ï¸ ãƒãƒƒãƒç®‡æ‰€ãŒå¤šã™ãã¾ã™ã€‚é–¾å€¤ã‚’èª¿æ•´ã™ã‚‹ã‹ã€ç¯„å›²ã‚’ç‹­ã‚ã¦ãã ã•ã„ã€‚")
        for pt in final_result_centered:
            log.append(f"X: {pt[0]}, Y: {pt[1]}")
            pt_left_top = (int(pt[0] - w / 2.0), int(pt[1] - h / 2.0))
            pt_right_bottom = (int(pt[0] + w / 2.0), int(pt[1] + h / 2.0))
            cv2.rectangle(img_color, pt_left_top, pt_right_bottom, (0, 0, 255), 2)
            cv2.circle(img_color, (pt[0], pt[1]), 10, (0, 255, 0), 2)
    else:
        log.append("âš ï¸ ãƒãƒƒãƒãªã—")

    cv2.imwrite("result.png", img_color)

    with open("result.png", "rb") as f:
        img_bytes = f.read()
    img_base64 = base64.b64encode(img_bytes).decode("utf-8")

except Exception as e:
    log.append("âŒ ã‚¨ãƒ©ãƒ¼: " + str(e))
    img_base64 = ""
    final_result_centered = []

positions_json = json.dumps(final_result_centered)

"\\n".join(log) + "\\n__SPLIT__\\n" + img_base64 + "\\n__SPLIT__\\n" + positions_json
`;

            try {
                const result = await pyodide.runPythonAsync(pythonCode);
                const [logText, imgBase64, positionsStr] = result.split("__SPLIT__");
                console.log("Pyodide ãƒ­ã‚°: ", logText);
                resultDiv.textContent = logText;

                if (imgBase64) {
                    imgEl.src = "data:image/png;base64," + imgBase64;
                    console.log("çµæœç”»åƒãŒè¨­å®šã•ã‚Œã¾ã—ãŸ");
                } else {
                    imgEl.src = "";
                    console.log("çµæœç”»åƒãŒã‚ã‚Šã¾ã›ã‚“");
                }

                console.log("ãƒ‘ãƒ¼ã‚¹å‰ã® positionsStr: ", positionsStr);
                let positions;
                try {
                    positions = JSON.parse(positionsStr);
                } catch (parseError) {
                    console.error("JSON ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ", parseError);
                    throw new Error("JSON ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: " + parseError.message + "\npositionsStr: " + positionsStr);
                }
                console.log("ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸä½ç½®: ", positions);
                return positions;
            } catch (err) {
                console.error("Pyodide å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ", err);
                resultDiv.textContent = "Pyodide å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: " + err.message;
                throw err;
            }
        }

        function displayResults(positions) {
            console.log("displayResults ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ: ", positions);
            const resultDiv = document.getElementById('result');
            coordinates = {};
            if (positions && positions.length > 0) {
                resultDiv.innerHTML = ''; // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢
                positions.forEach((pos, i) => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'result-row';
                    const label = `${i + 1}p : (${pos[0]}, ${pos[1]})`;
                    const labelSpan = document.createElement('span');
                    labelSpan.textContent = label;
                    const copyButton = document.createElement('button');
                    copyButton.textContent = 'ã‚³ãƒ”ãƒ¼';
                    copyButton.onclick = () => copyCoordinate(pos[0], pos[1]);
                    rowDiv.appendChild(labelSpan);
                    rowDiv.appendChild(copyButton);
                    resultDiv.appendChild(rowDiv);
                    coordinates[`${i + 1}P`] = pos;
                });
                console.log("çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ: ", positions);
            } else {
                resultDiv.textContent = "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                console.log("ãƒãƒƒãƒã™ã‚‹ä½ç½®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
                alert("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒå†…ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }

        function copyCoordinate(x, y) {
            const textToCopy = `${x}, ${y}`;
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert(`åº§æ¨™ (${textToCopy}) ãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼`);
            }).catch(err => {
                console.error("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ", err);
                alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
            });
        }

        function displayInitialResults(positions) {
            console.log("displayInitialResults ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ: ", positions);
            const initialResultDiv = document.getElementById('initialResult');
            if (positions.length > 0) {
                const resultText = positions.map((pos, i) => {
                    const key = `${pos[0]},${pos[1]}`;
                    const data = csvData[key] || { initial_position: '', string_to_show: 'ä¸æ˜' };
                    return `${i + 1}p : ${data.initial_position} ${data.string_to_show}`;
                }).join('\n');
                initialResultDiv.textContent = resultText;
            } else {
                initialResultDiv.textContent = "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                alert("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒå†…ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }
    </script>
</body>
</html>